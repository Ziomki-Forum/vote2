<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wyniki głosowania</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDrH70P_t7GEpfaFPISF9PmZu4TwhtmOTI",
      authDomain: "vote2-6e553.firebaseapp.com",
      projectId: "vote2-6e553",
      storageBucket: "vote2-6e553.firebasestorage.app",
      messagingSenderId: "426318102620",
      appId: "1:426318102620:web:e4b39f2f5f87dc34fd6699",
      measurementId: "G-7N5F3QPNLG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadLastClosedVoting() {
      const q = query(collection(db, "votings"), where("status", "==", "closed"));
      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
          document.getElementById("results").innerHTML = "Brak zakończonych głosowań";
          return;
        }
        let lastVoting = snapshot.docs[snapshot.docs.length-1];
        let counts = { ZA: 0, PRZECIW: 0, WSTRZYMUJĘ: 0 };

        onSnapshot(collection(db, "votings", lastVoting.id, "votes"), (votesSnap) => {
          votesSnap.forEach((doc) => {
            const v = doc.data();
            counts[v.vote] = (counts[v.vote] || 0) + 1;
          });
          const total = counts.ZA + counts.PRZECIW + counts.WSTRZYMUJĘ;
          document.getElementById("results").innerHTML = `
            <h2>${lastVoting.data().topic}</h2>
            <p>ZA: ${counts.ZA}</p>
            <p>PRZECIW: ${counts.PRZECIW}</p>
            <p>WSTRZYMUJĘ SIĘ: ${counts.WSTRZYMUJĘ}</p>
            <p>Łącznie: ${total}</p>
            <p>Procenty: ZA ${total?Math.round(counts.ZA/total*100):0}%, PRZECIW ${total?Math.round(counts.PRZECIW/total*100):0}%, WSTRZYMUJĘ SIĘ ${total?Math.round(counts.WSTRZYMUJĘ/total*100):0}%</p>
          `;
        });
      });
    }

    loadLastClosedVoting();
  </script>
  <style>
    body { font-family: Arial; padding: 20px; }
  </style>
</head>
<body>
  <h1>Wyniki ostatniego głosowania</h1>
  <div id="results">Ładowanie…</div>
</body>
</html>
